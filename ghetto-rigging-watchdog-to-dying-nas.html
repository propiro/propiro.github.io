<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
            <title>Ghetto-rigging watchdog to dying NAS - propiro.github.io </title>
        <meta name="description" content="tl;dr Have NAS NAS started randomly (3x a hour /every 3 months) shutting itself down, and "auto power on" didnt worked Decided to make a watchdog device to turn it on. Made a watchdog. Here is a story of something that should took 1hour, and&hellip;" />
        <meta name="robots" content="index, follow" />
        <meta name="generator" content="Publii Open-Source CMS for Static Site" />
        <link rel="canonical" href="https://propiro.github.io/ghetto-rigging-watchdog-to-dying-nas.html">
        <link rel="amphtml" href="https://propiro.github.io/amp/ghetto-rigging-watchdog-to-dying-nas.html">
        <link rel="alternate" type="application/atom+xml" href="https://propiro.github.io/feed.xml" />
<link rel="alternate" type="application/json" href="https://propiro.github.io/feed.json" />

        <meta property="og:title" content="Ghetto-rigging watchdog to dying NAS" /><meta property="og:image" content="https://propiro.github.io/media/website/distantgunfire.png"/><meta property="og:site_name" content="propiro.github.io" /><meta property="og:description" content="tl;dr Have NAS NAS started randomly (3x a hour /every 3 months) shutting itself down, and 'auto power on' didnt worked Decided to make a watchdog device to turn it on. Made a watchdog. Here is a story of something that should took 1hour, and&hellip;" /><meta property="og:url" content="https://propiro.github.io/ghetto-rigging-watchdog-to-dying-nas.html" /><meta property="og:type" content="article" /><meta name="twitter:card" content="summary" /><meta name="twitter:site" content="@propiro" /><meta name="twitter:title" content="Ghetto-rigging watchdog to dying NAS" /><meta name="twitter:description" content="tl;dr Have NAS NAS started randomly (3x a hour /every 3 months) shutting itself down, and 'auto power on' didnt worked Decided to make a watchdog device to turn it on. Made a watchdog. Here is a story of something that should took 1hour, and&hellip;" /><meta name="twitter:image" content="https://propiro.github.io/media/website/distantgunfire.png" />
	        <link rel="shortcut icon" href="https://propiro.github.io/media/website/icons8-automatic-50.png" type="image/x-icon" />
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>
        <link href="https://fonts.googleapis.com/css?family=Roboto:400,500&amp;display=swap" rel="stylesheet">   
        <link rel="stylesheet" href="https://propiro.github.io/assets/css/style.css?v=42b8f09712c8c3a333df1c2198305905">
                 <link rel="stylesheet" href="https://propiro.github.io/assets/css/photoswipe.css?v=f94529aaf8fd74b3f05f3587577a203d">
        <script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://propiro.github.io/ghetto-rigging-watchdog-to-dying-nas.html"},"headline":"Ghetto-rigging watchdog to dying NAS","datePublished":"2021-02-13T14:19","dateModified":"2021-02-13T14:49","description":"tl;dr Have NAS NAS started randomly (3x a hour /every 3 months) shutting itself down, and \"auto power on\" didnt worked Decided to make a watchdog device to turn it on. Made a watchdog. Here is a story of something that should took 1hour, and&hellip;","author":{"@type":"Person","name":"piro"},"publisher":{"@type":"Organization","name":"piro"}}</script>
        	<script async src="https://propiro.github.io/assets/js/lazysizes.min.js?v=2b604cc54166522c287f131ead6e4d44"></script>
		            <style>				
				          .pswp--svg .pswp__button,
				          .pswp--svg .pswp__button--arrow--left:before,
				          .pswp--svg .pswp__button--arrow--right:before {
					          background-image: url(https://propiro.github.io/assets/svg/gallery-icons-light.svg);
			              }
		            </style>		        
        
        
    </head>
    <body>
        
<div class="container">
      <nav class="menu">
          <ul class="navbar__menu">
                  <li>
                  <span>./MAIN/</span>
      
              </li>
                  <li class="has-submenu">
                  <span>./MAIN/WORK/</span>
      
                          <ul class="navbar__submenu" >
                                  <li>
                                  <a href="https://propiro.github.io/maxscript/" target="_self">./MAIN/WORK/maxscript/</a>
                      
                              </li>
                                  <li>
                                  <a href="https://propiro.github.io/3d-tag/" target="_self">./MAIN/WORK/3d/</a>
                      
                              </li>
                          </ul>
              </li>
                  <li class="has-submenu">
                  <a href="https://propiro.github.io/hacks/" target="_self">./MAIN/SOCIAL/</a>
      
                          <ul class="navbar__submenu" >
                                  <li>
                                  <a href="https://propiro.github.io/internet/" target="_self">./MAIN/SOCIAL/internet/</a>
                      
                              </li>
                                  <li>
                                  <a href="https://propiro.github.io/general_rant/" target="_self">./MAIN/SOCIAL/rant/</a>
                      
                              </li>
                                  <li>
                                  <span>./MAIN/SOCIAL/misc</span>
                      
                              </li>
                          </ul>
              </li>
                  <li class="has-submenu">
                  <a href="https://propiro.github.io/shopping/" target="_self">./MAIN/NOT_WORK/</a>
      
                          <ul class="navbar__submenu" >
                                  <li>
                                  <a href="https://propiro.github.io/hacks/" target="_self">./MAIN/NOT_WORK/hacks/</a>
                      
                              </li>
                                  <li>
                                  <a href="https://propiro.github.io/shopping/" target="_self">./MAIN/NOT_WORK/Shopping</a>
                      
                              </li>
                          </ul>
              </li>
          </ul>
          <button class="menu__close js-menu__close">Close</button>
      </nav>
   <div class="content js-content">
      <header>
         <div class="top">
            <a class="logo" href="https://propiro.github.io/">
                  propiro.github.io
            </a>
         </div>
         <div class="top top--right is-sticky">
               <button class="menu-toggle js-menu-toggle">
                  Menu
               </button>
         </div>
      </header>
      <main class="main">
            <article class="post">
               <div class="main__left">


                  <header>
                     <h1>Ghetto-rigging watchdog to dying NAS</h1>
                        <p>
                              <time datetime="2021-02-13T14:19">
                                    13/02/2021
                              </time>
                              by
                                 <a href="https://propiro.github.io/authors/piro/" rel="author" title="piro">piro</a>
                        </p>
                  </header>
               </div>
               <div class="main__right">
                  <div class="post__entry">
                        <p><em>tl;dr</em><br><em>Have NAS</em><br><em>NAS started randomly (3x a hour /every 3 months) shutting itself down, and "auto power on" didnt worked</em><br><em>Decided to make a watchdog device to turn it on.</em><br><em>Made a watchdog.</em></p>
<p>Here is a story of something that should took 1hour, and took 5h, because chinkman decided to mix the colors in usb cable, and i've assumed immidiately that i did everyting wrong, checking polarisation of usb cable at the very end. Thats 85cent attiny in damages, and 4h of crazy debugging of what was wrong.</p>
<p>Thats beign said:</p>
<p>My QNAP NAS for some time had a weird issue, where it'd shut itself down (thermals are ok, ram is ok, hdds are ok, believe me i've tried everything), and QNAP service after 2 months of pingponging my messages said finally that warranty period is over, sucks to be me. </p>
<p>I can live with 3-4minute downtimes before it reboots, however, the most annoying problem (connected to the shutdowns I assume) is that power button dont work immidiately - I press it, and there is random chane of it working and booting, or just powering system for a split second, and shutting it down (capacitor issue? Im lacking technocal knowledge to diagnose it sadly). Sometimes it works at 3rd press, sometimes at 40th press, and the attempted boot - shutdown cucle takes around 5 seconds, and I really dont want to spent 5 minutes standing near my hardware rack pressing button.</p>
<p>So, a watchdog idea was made:<br>- it has to be as low invasive as possible<br>- it should give me ability to swap parts rather quickly, without much desoldering<br>- it should be inside NAS, no dangling cables<br>- it should be somewhat "smart" - dont just press the button infinitely, but detect if system turned on<br>- it can be turned on/off, in case i want to swap disks for example<br>- must me made using zipties</p>
<p>Schemats is quite simple:</p>
<figure class="post__image post__image" ><img class="lazyload" src="https://propiro.github.io/media/posts/22/responsive/2021-02-13_14h17_04-xs.png" data-sizes="auto" data-srcset="https://propiro.github.io/media/posts/22/responsive/2021-02-13_14h17_04-xs.png 300w ,https://propiro.github.io/media/posts/22/responsive/2021-02-13_14h17_04-sm.png 480w ,https://propiro.github.io/media/posts/22/responsive/2021-02-13_14h17_04-md.png 768w"  alt="watchdog schematic" width="1235" height="886">
<figcaption >simple schemat of part connections</figcaption>
</figure>
<p>So general idea is:<br>Its powered by step-down converter that makes 5V for attiny85 from NAS 12V, its soldered directly to the motherboard pads to feed power as soon as power is plugged in.<br>It monitors USB power, resistor is to eliminate noise (randomly picked because im lazy, values are calibrated in code)<br>In case no USB power is detected, it starts routine of "pressing" the switch for 200ms through relay breakboard.</p>
<p>Few pictures of how it went, with short descriptions.</p>
<div class="gallery"  data-is-empty="false" data-columns="2">
<figure class="gallery__item"><a href="https://propiro.github.io/media/posts/22/gallery/2021-02-13_14h35_14.png" data-size="1096x709"><img src="https://propiro.github.io/media/posts/22/gallery/2021-02-13_14h35_14-thumbnail.png" alt="power button rigged" width="768" height="497"></a>
<figcaption class="gallery-description">power button rigged</figcaption>
</figure>
<figure class="gallery__item"><a href="https://propiro.github.io/media/posts/22/gallery/2021-02-13_14h39_19.png" data-size="2330x1831"><img src="https://propiro.github.io/media/posts/22/gallery/2021-02-13_14h39_19-thumbnail.png" alt="zip-tied bondage attiny+relay" width="768" height="604"></a>
<figcaption class="gallery-description">zip-tied bondage attiny+relay</figcaption>
</figure>
<figure class="gallery__item"><a href="https://propiro.github.io/media/posts/22/gallery/2021-02-13_14h40_07.png" data-size="1221x853"><img src="https://propiro.github.io/media/posts/22/gallery/2021-02-13_14h40_07-thumbnail.png" alt="working dongle, testing" width="768" height="537"></a>
<figcaption class="gallery-description">working dongle, testing</figcaption>
</figure>
<figure class="gallery__item"><a href="https://propiro.github.io/media/posts/22/gallery/photo5852529884906239710.jpg" data-size="1280x960"><img src="https://propiro.github.io/media/posts/22/gallery/photo5852529884906239710-thumbnail.jpg" alt="usb vcc and ground supplied to analog pin" width="768" height="576"></a>
<figcaption class="gallery-description">usb vcc and ground supplied to analog pin</figcaption>
</figure>
</div>
<p>And code that runs on the watchdog:</p>
<p><code><br>#define NUM_SAMPLES 10<br>#define LED_PIN 1<br>#define ANALOG_PIN A3<br>#define POWER_PIN 4<br>#define RESTART_DELAY 1400<br>#define WORKING_VOLTAGE 4.1<br><br>bool restartingLED = true;<br> int samplesSum = 0;<br> unsigned char sample_count = 0;<br> float voltage = 0.0;<br><br>// the setup routine runs once when you press reset:<br>void setup() {<br> randomSeed(analogRead(0));<br> // initialize the digital pin as an output.<br> //pinMode(0, OUTPUT); //LED on Model B<br> pinMode(LED_PIN, OUTPUT); //LED on Model A or Pro<br> pinMode(POWER_PIN, OUTPUT); // relay<br> pinMode(ANALOG_PIN, INPUT); //<br><br>}<br><br>// the loop routine runs over and over again forever:<br>void loop() {<br><br>//pressPower(100);<br>//delay(1000);<br> while (sample_count &lt; NUM_SAMPLES) {<br> <br> //samplesSum += debugAnalogRead(300, 100);<br> <br> samplesSum += analogRead(ANALOG_PIN);<br> sample_count++;<br> if (restartingLED == true) {digitalWrite(1, HIGH);}<br> delay(100);<br> if (restartingLED == true) {digitalWrite(1, LOW);}<br> <br> }<br> voltage = ((float)samplesSum / (float)NUM_SAMPLES * 5.015) / 1024.0;<br><br>if (voltage &lt; WORKING_VOLTAGE)<br>{<br> <br> restartingLED = true;<br> pressPower(200);<br> }<br> if (voltage &gt;= WORKING_VOLTAGE)<br> {<br> restartingLED = false;<br> }<br> // wait for a second<br><br>sample_count = 0;<br>samplesSum = 0;<br>}<br><br><br>void pressPower(float delayVal)<br>{<br> digitalWrite( 4, HIGH);<br> delay(delayVal);<br> digitalWrite(4, LOW);<br> delay(RESTART_DELAY - delayVal);<br><br>}<br><br>void turnLed(int state)<br>{<br> if (state == 0)<br> {<br> digitalWrite(1, LOW);<br> }<br> if (state == 1)<br> {<br> digitalWrite(1, HIGH);<br> }<br>}<br><br>float debugAnalogRead(float voltage, float range)<br>{<br> float voltageReturn = 0;<br> voltageReturn = voltage + random(-1 * range, range);<br><br> return voltageReturn;<br>}<br></code></p>
<p> What I've learned during making this, is that to never trust chinesse manufacturers - my usb cable that i've used had colors swapped for ground and vcc, so i've managed to burn 2 attinys before checking EVERYTHING on my side, only to find this issue after 5h of debugging.</p>
<p>Anyway, it works, and by frantical clicking it lets me know IF the server actually died ;-)</p>
<p> </p>
<p> </p>
<p> </p>

                        <footer>
                                 <ul class="post__tag">
                                       <li>
                                          <a href="https://propiro.github.io/diy/">DIY</a>
                                       </li>
                                       <li>
                                          <a href="https://propiro.github.io/hacks/">hacks</a>
                                       </li>
                                       <li>
                                          <a href="https://propiro.github.io/other/">other</a>
                                       </li>
                                       <li>
                                          <a href="https://propiro.github.io/tech/">technology</a>
                                       </li>
                                 </ul>

                              <div class="post__share">
                                  <a href="https://www.facebook.com/sharer/sharer.php?u=https%3A%2F%2Fpropiro.github.io%2Fghetto-rigging-watchdog-to-dying-nas.html" class="js-share facebook" title="Share with Facebook" rel="nofollow noopener noreferrer">
                                     <svg>
                                         <use xlink:href="https://propiro.github.io/assets/svg/svg-map.svg#facebook" />
                                     </svg>
                                 </a>
                                 
                                 <a href="https://twitter.com/share?url=https%3A%2F%2Fpropiro.github.io%2Fghetto-rigging-watchdog-to-dying-nas.html&amp;via=%40piropro&amp;text=Ghetto-rigging%20watchdog%20to%20dying%20NAS
                                 " class="js-share twitter" title="Share with Twitter" rel="nofollow noopener noreferrer">
                                     <svg>
                                         <use xlink:href="https://propiro.github.io/assets/svg/svg-map.svg#twitter" />
                                     </svg>
                                 </a>
                                 
                                 <a href="https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fpropiro.github.io%2Fghetto-rigging-watchdog-to-dying-nas.html&amp;media=undefined&amp;description=Ghetto-rigging%20watchdog%20to%20dying%20NAS" class="js-share pinterest" title="Share with Pinterest" rel="nofollow noopener noreferrer">
                                     <svg>
                                         <use xlink:href="https://propiro.github.io/assets/svg/svg-map.svg#pinterest" />
                                     </svg>
                                 </a>
                                 
                                 
                                 
                                 <a href="https://buffer.com/add?text=Ghetto-rigging%20watchdog%20to%20dying%20NAS&amp;url=https%3A%2F%2Fpropiro.github.io%2Fghetto-rigging-watchdog-to-dying-nas.html" class="js-share buffer" title="Share with Buffer" rel="nofollow noopener noreferrer">
                                     <svg>
                                         <use xlink:href="https://propiro.github.io/assets/svg/svg-map.svg#buffer" />
                                     </svg>
                                 </a>
                              </div>

                        </footer>
                  </div>
               </div>
            </article>

               <div class="tank">
                     <div id="disqus_thread"></div>
                     <script>
                         var disqus_config = function () {
                             this.page.url = 'https://propiro.github.io/ghetto-rigging-watchdog-to-dying-nas.html';
                     		this.page.identifier = '22';
                             this.page.title = ' Ghetto-rigging watchdog to dying NAS';
                         };
                     
                         var disqus_loaded = false;
                     
                         function publiiLoadDisqus() {
                             if(disqus_loaded) {
                                 return false;
                             }
                     
                             var top = document.getElementById('disqus_thread').offsetTop;
                     
                             if (!disqus_loaded && (window.scrollY || window.pageYOffset) + window.innerHeight > top) {
                                 disqus_loaded = true;
                     
                                 (function () {
                                     var d = document, s = d.createElement('script');
                                     s.src = 'https://propiro.disqus.com/embed.js';
                                     s.setAttribute('data-timestamp', +new Date());
                                     (d.head || d.body).appendChild(s);
                                 })();
                             }
                         }
                     
                         publiiLoadDisqus();
                     
                         window.onscroll = function() {
                             publiiLoadDisqus();
                         };
                     </script>
                     <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>
               </div>
          
      </main>
      <footer class="footer">
            <div class="footer__copyright">
               <p class="align-right">      This is just a footer. If you want, you can contact me on:</p>
      <p class="align-right">      <a href="mailto:pro.piro+ghpages@gmail.com"> pro.piro[at]gmail.com</a></p>
      <script type="text/javascript" src="//counter.websiteout.net/js/36/10/231/0"></script>
            </div>
      </footer>
      </div>
      </div>
      <script defer src="https://propiro.github.io/assets/js/jquery-3.2.1.slim.min.js?v=f307ecc7f6353949f03c06ffa70652a2"></script>
      <script defer src="https://propiro.github.io/assets/js/scripts.js?v=2f88524543ee97cef94edcae42c42b7f"></script>
                <script defer src="https://propiro.github.io/assets/js/photoswipe.min.js?v=9c62086e50d89a9b6a29389a70ee0d65"></script>
                <script defer src="https://propiro.github.io/assets/js/photoswipe-ui-default.min.js?v=aafb02c13ce2b295ff34a8ac0db67cbb"></script>        
                <script>var initPhotoSwipeFromDOM=function(gallerySelector){var parseThumbnailElements=function(el){var thumbElements=el.childNodes,numNodes=thumbElements.length,items=[],figureEl,linkEl,size,item;for(var i=0;i<numNodes;i++){figureEl=thumbElements[i];if(figureEl.nodeType!==1){continue;}
                linkEl=figureEl.children[0];size=linkEl.getAttribute('data-size').split('x');item={src:linkEl.getAttribute('href'),w:parseInt(size[0],10),h:parseInt(size[1],10)};if(figureEl.children.length>1){item.title=figureEl.children[1].innerHTML;}
                if(linkEl.children.length>0){item.msrc=linkEl.children[0].getAttribute('src');}
                item.el=figureEl;items.push(item);}
                return items;};var closest=function closest(el,fn){return el&&(fn(el)?el:closest(el.parentNode,fn));};var onThumbnailsClick=function(e){e=e||window.event;e.preventDefault?e.preventDefault():e.returnValue=false;var eTarget=e.target||e.srcElement;var clickedListItem=closest(eTarget,function(el){return(el.tagName&&el.tagName.toUpperCase()==='FIGURE');});if(!clickedListItem){return;}
                var clickedGallery=clickedListItem.parentNode,childNodes=clickedListItem.parentNode.childNodes,numChildNodes=childNodes.length,nodeIndex=0,index;for(var i=0;i<numChildNodes;i++){if(childNodes[i].nodeType!==1){continue;}
                if(childNodes[i]===clickedListItem){index=nodeIndex;break;}
                nodeIndex++;}
                if(index>=0){openPhotoSwipe(index,clickedGallery);}
                return false;};var photoswipeParseHash=function(){var hash=window.location.hash.substring(1),params={};if(hash.length<5){return params;}
                var vars=hash.split('&');for(var i=0;i<vars.length;i++){if(!vars[i]){continue;}
                var pair=vars[i].split('=');if(pair.length<2){continue;}
                params[pair[0]]=pair[1];}
                if(params.gid){params.gid=parseInt(params.gid,10);}
                return params;};var openPhotoSwipe=function(index,galleryElement,disableAnimation,fromURL){var pswpElement=document.querySelectorAll('.pswp')[0],gallery,options,items;items=parseThumbnailElements(galleryElement);options={galleryUID:galleryElement.getAttribute('data-pswp-uid'),getThumbBoundsFn:function(index){var thumbnail=items[index].el.getElementsByTagName('img')[0],pageYScroll=window.pageYOffset||document.documentElement.scrollTop,rect=thumbnail.getBoundingClientRect();return{x:rect.left,y:rect.top+pageYScroll,w:rect.width};},
                mainClass:'pswp--dark',
                preload: [1,2],
                hideAnimationDuration:200,
                showAnimationDuration:0,
                bgOpacity: 0.7,
                showHideOpacity:true,
                closeOnScroll: true,
                arrowKeys: true,
                closeEl: true,
                captionEl: true,
                fullscreenEl: true,
                zoomEl: true,
                shareEl: true,
                counterEl: true,
                arrowEl: true,
                preloaderEl: true
                };if(fromURL){if(options.galleryPIDs){for(var j=0;j<items.length;j++){if(items[j].pid==index){options.index=j;break;}}}else{options.index=parseInt(index,10)-1;}}else{options.index=parseInt(index,10);}
                if(isNaN(options.index)){return;}
                if(disableAnimation){options.showAnimationDuration=0;}
                gallery=new PhotoSwipe(pswpElement,PhotoSwipeUI_Default,items,options);gallery.init();gallery.options.escKey=true;};var galleryElements=document.querySelectorAll(gallerySelector);for(var i=0,l=galleryElements.length;i<l;i++){galleryElements[i].setAttribute('data-pswp-uid',i+1);galleryElements[i].onclick=onThumbnailsClick;}
                var hashData=photoswipeParseHash();if(hashData.pid&&hashData.gid){openPhotoSwipe(hashData.pid,galleryElements[hashData.gid-1],true,true);}};initPhotoSwipeFromDOM('.gallery');</script>
                	<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
                		<div class="pswp__bg"></div>
                		<div class="pswp__scroll-wrap">
                			<div class="pswp__container">
                				<div class="pswp__item"></div>
                				<div class="pswp__item"></div>
                				<div class="pswp__item"></div>
                			</div>
                			<div class="pswp__ui pswp__ui--hidden">
                				<div class="pswp__top-bar">
                					<div class="pswp__counter"></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                					<button class="pswp__button pswp__button--share" title="Share"></button>
                					<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                					<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                					<div class="pswp__preloader">
                						<div class="pswp__preloader__icn">
                							<div class="pswp__preloader__cut">
                								<div class="pswp__preloader__donut"></div>
                							</div>
                						</div>
                					</div>
                				</div>
                				<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                					<div class="pswp__share-tooltip"></div>
                				</div>
                				<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
                				<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button>
                				<div class="pswp__caption">
                					<div class="pswp__caption__center"></div>
                				</div>
                			</div>
                		</div>
                	</div>
      
      </body>
      </html>